name: getproxy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0/15 * * * *'  #   分 时 日 月 周

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Clone parser_proxy_2 repository
      run: |
        git config --global user.name "fate0"
        git config --global user.email "git@fatezero.org"
        git clone https://github.com/parserpp/parser_proxy_2.git getproxy_src
        cd getproxy_src
        pip install -e .

    - name: run getproxy
      run: |
        getproxy --in-proxy=proxy.list --out-proxy=proxy.list.out --token=${{ secrets.GTOKEN }}

    - name: Upload to ip_ports and cleanup
      run: |
        python3 -c "
        import sys
        sys.path.insert(0, 'getproxy_src')
        from getproxy.github_api import update_content, delete_file
        import os

        token = os.getenv('GTOKEN')
        if not token:
            print('Error: GTOKEN not found')
            sys.exit(1)

        # Upload proxy.list
        if os.path.exists('proxy.list'):
            print('Uploading proxy.list to ip_ports...')
            with open('proxy.list', 'r') as f:
                update_content('parserpp', 'ip_ports', '/proxy.list', _token=token, _content_not_base64=f.read())
            os.remove('proxy.list')
            print('✓ Deleted proxy.list')

        # Upload proxy.list.out
        if os.path.exists('proxy.list.out'):
            print('Uploading proxy.list.out to ip_ports...')
            with open('proxy.list.out', 'r') as f:
                update_content('parserpp', 'ip_ports', '/proxy.list.out', _token=token, _content_not_base64=f.read())
            os.remove('proxy.list.out')
            print('✓ Deleted proxy.list.out')
        "


